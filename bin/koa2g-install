#!/usr/bin/env node

var program = require('commander');
var path = require('path');
var fs = require('fs');
var child_process = require('child_process');
// var spawn = child_process.spawn;
// var spawn = child_process.exec();
var path_util = require('../utils/path');
var pkg = require('../package.json');

var version = pkg.version;

program
    .version(version)
    .usage('[options]')
    .option('-d, --directory [directory]', 'the target directory (defaults to ./)')
    .parse(process.argv);

main();

/**
 * install application at the given directory `directory`.
 * @param directory
 */
function installApplication(directory) {
    var package_file = path.join(directory, 'package.json');
    console.log('package: ' + package_file);
    fs.exists(package_file, function (exists) {
        if (exists) { // existed
            console.error('aborting! because package.json is existed');
        } else {
            installDependencies(directory);
        }
    });
}

function installDependencies(directory) {
    console.log('installDependencies');
    process.chdir(directory);
    var cwd = process.cwd();
    console.log('cwd: ' + cwd);
    child_process.exec('npm init');
}

/**
 * Main program.
 */

function main() {
    // Directory
    // console.log('directory: ' + program.directory);
    var cwd = process.cwd();
    if (program.directory && program.directory.length > 0) {
        var directory = path.resolve(cwd,program.directory);
    } else {
        var directory = process.cwd();
    }
    console.log('directory: ' + directory);

    // Generate application
    path_util.existedDirectory(directory, function (existed) {
        console.log('existed: ' + (existed ? 'true' : 'false'));
        if (existed) {
            installApplication(directory);
        } else {
            path_util.mkdir(directory, function () {
                installApplication(directory);
            });
        }
    });
}
